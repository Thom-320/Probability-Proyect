---
title: "Entrega 1 - Notebook Reproducible"
author: '[Integrantes del Grupo]'
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    keep_tex: false
  html_document:
    toc: true
    number_sections: true
    df_print: paged
  html_notebook:
    toc: true
    number_sections: true
    df_print: paged
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 7, fig.height = 4, dpi = 150)
set.seed(123)
```

# 1. Carga de Librerías

```{r libraries}
suppressPackageStartupMessages({
  library(tidyverse)
  library(janitor)
  library(psych)
  library(readr)
  library(corrplot)
  library(rstatix)
  library(effectsize)
  library(patchwork)
})
render_table <- function(data, caption = NULL, html_font_size = 10, ...) {
  tab <- knitr::kable(data, caption = caption, ...)
  if (knitr::is_html_output()) {
    tab <- kableExtra::kable_styling(tab, font_size = html_font_size)
  }
  tab
}
```

# 2. Carga y Exploración Inicial de Datos

```{r load-data}
# Carga reproducible (ruta relativa)
df <- read_csv("/Users/thom/Library/Mobile Documents/com~apple~CloudDocs/Universidad/Proba 2/Probability-Proyect/data/health_lifestyle_classification.csv", show_col_types = FALSE) %>% clean_names()
cat("Filas:", nrow(df), " - Columnas:", ncol(df), "\n")
str(df, give.attr = FALSE)
```

```{r missing-summary}
missing_tbl <- df %>% summarise(across(everything(), ~sum(is.na(.)))) %>% pivot_longer(everything(), names_to = "variable", values_to = "na") %>% mutate(pct = round(100*na/nrow(df),2)) %>% arrange(desc(pct))
missing_tbl %>%
  head(15) %>%
  render_table(col.names = c("Variable","NA","%NA"), caption = "Top 15 variables con mayor NA", html_font_size = 10)
```

# 3. Tipología de Variables

```{r variable-types}
chr_vars <- names(df %>% select(where(is.character)))
num_vars <- names(df %>% select(where(is.numeric)))
list(chr_vars = chr_vars[1:20], num_vars = num_vars[1:20])
```

# 4. Marco Metodológico Completo

## Origen de los Datos
Los datos provienen del dataset "Health Lifestyle Classification" que contiene información recolectada sobre hábitos de salud y estilo de vida. El dataset incluye variables demográficas, biométricas, de comportamiento, salud mental y socioeconómicas recopiladas mediante encuestas estructuradas.

## Objetivo del Análisis
Caracterizar los patrones de salud y estilo de vida en la población estudiada mediante técnicas de estadística descriptiva e inferencial, específicamente:
1. Describir distribuciones univariadas y bivariadas
2. Identificar relaciones entre variables
3. Evaluar si el BMI promedio poblacional difiere de 25 kg/m²
4. Determinar si la proporción de individuos saludables difiere del 50%

# 5. Análisis Descriptivo de Variables Categóricas

```{r categorical-univariate}
cat_vars <- chr_vars
cat_summary <- map_df(cat_vars, ~df %>% count(.data[[.x]]) %>% mutate(variable = .x) %>% rename(valor = 1, frecuencia = n))
cat_summary %>%
  group_by(variable) %>%
  mutate(pct = round(100*frecuencia/sum(frecuencia),2)) %>%
  ungroup() %>%
  head(40) %>%
  render_table(caption = "Frecuencias (primeras 40 filas)", html_font_size = 10)
```

```{r categorical-treemap, warning=FALSE, message=FALSE, fig.width=7, fig.height=5}
if(!requireNamespace("treemapify", quietly = TRUE)) {
  # opcional: instalar en entorno local si falta
  # install.packages("treemapify")
}
if("occupation" %in% names(df) && require(treemapify)) {
  df %>%
    count(occupation) %>%
    filter(!is.na(occupation)) %>%
    ggplot(aes(area = n, fill = n, label = occupation)) +
    geom_treemap() +
    geom_treemap_text(reflow = TRUE, colour = "white", place = "centre", grow = TRUE) +
    labs(title = "Treemap de Occupation", fill = "Frecuencia") +
    theme_minimal()
}
```

```{r categorical-plots, fig.height=5, fig.width=8}
key_cat <- intersect(c("gender","target","education_level","diet_type"), names(df))
plot_list <- map(key_cat, ~{
  ggplot(df, aes(x = .data[[.x]])) +
    geom_bar(fill = "steelblue", alpha = 0.8) +
    geom_text(stat = "count", aes(label = after_stat(count)), vjust = -0.3, size = 3) +
    labs(title = .x, x = NULL, y = "Frecuencia") +
    theme_minimal()
})
wrap_plots(plotlist = plot_list)
```

```{r categorical-bivariate}
if(all(c("gender","target") %in% names(df))) {
  tab_gt <- df %>% filter(!is.na(gender), !is.na(target)) %>% count(gender, target) %>% group_by(gender) %>% mutate(pct = round(100*n/sum(n),1))
  tab_gt %>% render_table(caption = "Tabla de contingencia: gender x target")
  # Chi-cuadrado y Cramer's V
  chi_tab <- table(df$gender, df$target)
  chi_obj <- suppressWarnings(chisq.test(chi_tab))
  cramer <- effectsize::cramers_v(chi_tab)
  cat("\nChi-cuadrado:", round(chi_obj$statistic,3), "(gl=", chi_obj$parameter, ") p=", signif(chi_obj$p.value,3), "\n")
  cat("Cramer's V:", round(cramer$Cramers_v,3), "Magnitud:", cramer$Magnitude, "\n")
}
```

```{r categorical-bivariate-plots, fig.width=8, fig.height=4}
# Gráfico de barras apiladas
if(all(c("gender","target") %in% names(df))) {
  p_stacked <- df %>% filter(!is.na(gender), !is.na(target)) %>% 
    ggplot(aes(x = gender, fill = target)) +
    geom_bar(position = "fill") +
    geom_text(stat = "count", aes(label = after_stat(count)), position = position_fill(vjust = 0.5)) +
    labs(title = "Proporción de Target por Género", x = "Género", y = "Proporción", fill = "Target") +
    theme_minimal()
  
  # Si hay education_level, hacer otro bivariado
  if("education_level" %in% names(df)) {
    p_education <- df %>% filter(!is.na(education_level), !is.na(target)) %>% 
      ggplot(aes(x = education_level, fill = target)) +
      geom_bar(position = "dodge") +
      labs(title = "Target por Nivel Educativo", x = "Educación", y = "Frecuencia", fill = "Target") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
    
    p_stacked + p_education
  } else {
    p_stacked
  }
}
```

# 6. Análisis Descriptivo de Variables Cuantitativas

```{r numeric-summary}
num_vars <- setdiff(num_vars, c("survey_code"))
desc_tbl <- df %>% select(any_of(num_vars)) %>% psych::describe() %>% as.data.frame() %>% rownames_to_column("variable") %>% select(variable, n, mean, sd, median, min, max, skew, kurtosis)
desc_tbl %>%
  filter(variable %in% c("age","bmi","height","weight","sleep_hours","daily_steps")) %>%
  render_table(caption = "Estadígrafos variables clave (básicos)", html_font_size = 9)
```

```{r numeric-extended}
mode_vec <- function(x){ux <- na.omit(unique(x)); ux[which.max(tabulate(match(x, ux)))]}
num_extended <- df %>% select(any_of(num_vars)) %>% pivot_longer(everything(), names_to="variable", values_to="value") %>% group_by(variable) %>% summarise(
  n = sum(!is.na(value)),
  mean = mean(value, na.rm=TRUE),
  median = median(value, na.rm=TRUE),
  mode = mode_vec(value),
  sd = sd(value, na.rm=TRUE),
  iqr = IQR(value, na.rm=TRUE),
  p10 = quantile(value,0.10, na.rm=TRUE),
  p25 = quantile(value,0.25, na.rm=TRUE),
  p75 = quantile(value,0.75, na.rm=TRUE),
  p90 = quantile(value,0.90, na.rm=TRUE),
  skew = psych::skew(value, na.rm=TRUE),
  kurt = psych::kurtosi(value, na.rm=TRUE)
)
num_extended %>%
  filter(variable %in% c("age","bmi","sleep_hours","daily_steps")) %>%
  render_table(caption="Estadísticos extendidos (forma y posición)", html_font_size = 9)
```

```{r numeric-histograms, fig.width=8, fig.height=6}
vars_plot <- intersect(c("age","bmi","sleep_hours","daily_steps"), names(df))
plots_h <- map(vars_plot, ~{
  ggplot(df, aes(x = .data[[.x]])) +
    geom_histogram(bins = 30, fill = "#69b3a2", color = "white") +
    labs(title = paste("Histograma", .x), x = .x, y = "freq") +
    theme_minimal()
})
wrap_plots(plotlist = plots_h)
```

```{r numeric-boxplots, fig.width=8, fig.height=3}
plots_b <- map(vars_plot, ~{
  ggplot(df, aes(y = .data[[.x]])) +
    geom_boxplot(fill = "#ffab00", alpha = 0.7) +
    labs(title = paste("Boxplot", .x), y = .x) +
    theme_minimal()
})
wrap_plots(plotlist = plots_b, ncol = length(plots_b))
```

# 7. Correlaciones

```{r correlations, fig.width=6, fig.height=5}
cor_vars <- intersect(c("age","bmi","height","weight","sleep_hours","daily_steps"), names(df))
cmat <- cor(df[cor_vars], use = "complete.obs")
corrplot(cmat, method = "color", type = "upper", addCoef.col = "black", tl.col = "black", number.cex = 0.6)
```

```{r scatter-plots, fig.width=8, fig.height=6}
# Diagramas de dispersión para correlaciones altas
if(all(c("height","weight","bmi","age") %in% names(df))) {
  p1 <- ggplot(df, aes(x = height, y = weight)) + geom_point(alpha = 0.6) + geom_smooth(method = "lm", se = FALSE) + theme_minimal()
  p2 <- ggplot(df, aes(x = weight, y = bmi)) + geom_point(alpha = 0.6) + geom_smooth(method = "lm", se = FALSE) + theme_minimal()
  p3 <- ggplot(df, aes(x = height, y = bmi)) + geom_point(alpha = 0.6) + geom_smooth(method = "lm", se = FALSE) + theme_minimal()
  p4 <- ggplot(df, aes(x = age, y = bmi)) + geom_point(alpha = 0.6) + geom_smooth(method = "lm", se = FALSE) + theme_minimal()
  (p1 + p2) / (p3 + p4)
}
```

## 6.1 Análisis Distribucional

```{r distributional-analysis, fig.width=8, fig.height=6}
# QQ-plots para evaluar normalidad
key_vars <- intersect(c("age","bmi","sleep_hours","daily_steps"), names(df))
qq_plots <- map(key_vars, ~{
  ggplot(df, aes(sample = .data[[.x]])) +
    stat_qq() + stat_qq_line() +
    labs(title = paste("QQ-plot:", .x)) +
    theme_minimal()
})
wrap_plots(plotlist = qq_plots)
```

```{r normality-tests}
# Tests de normalidad
normality_results <- map_df(key_vars, ~{
  if(.x %in% names(df)) {
    vec <- df %>% filter(!is.na(.data[[.x]])) %>% pull(.data[[.x]])
    if(length(vec) > 5000) vec <- sample(vec, 5000)
    sw_test <- shapiro.test(vec)
    data.frame(variable = .x, shapiro_w = sw_test$statistic, shapiro_p = sw_test$p.value)
  }
})
normality_results %>% render_table(caption = "Tests de Normalidad (Shapiro-Wilk)")
```

```{r distribution-suggestions}
dist_suggestions <- num_extended %>% filter(variable %in% c("age","bmi","sleep_hours","daily_steps")) %>% mutate(
  sugerida = case_when(
    abs(skew) < 0.3 & abs(kurt) < 1 ~ "Normal",
    skew > 0.8 ~ "Gamma / Log-normal",
    skew > 0.3 & skew <= 0.8 ~ "Asimetría leve (aprox. Normal tras transf.)",
    TRUE ~ "Revisar visual"
  )
) %>% select(variable, skew, kurt, sugerida)
dist_suggestions %>% render_table(caption="Sugerencias distribucionales basadas en forma", html_font_size = 9)
```

# 8. Análisis Mixto (Cuantitativas vs Categóricas)

```{r bmi-by-gender}
if(all(c("bmi","gender") %in% names(df))) {
  bmi_gender_stats <- df %>% filter(!is.na(bmi), !is.na(gender)) %>% group_by(gender) %>% summarise(n = n(), mean = mean(bmi), sd = sd(bmi), median = median(bmi), q1 = quantile(bmi,0.25), q3 = quantile(bmi,0.75), .groups = "drop")
  bmi_gender_stats %>% render_table(caption = "BMI por género")
}
```

```{r bmi-by-gender-plots, fig.width=8, fig.height=4}
if(all(c("bmi","gender") %in% names(df))) {
  p_box <- ggplot(df, aes(x = gender, y = bmi, fill = gender)) + geom_boxplot(alpha = 0.7) + theme_minimal() + theme(legend.position = "none")
  p_hist <- ggplot(df, aes(x = bmi, fill = gender)) + geom_histogram(position = "identity", alpha = 0.4, bins = 30) + facet_wrap(~gender) + theme_minimal() + theme(legend.position = "none")
  p_box + p_hist
}
```

```{r additional-mixed-analysis}
# Análisis adicional: Age por Target si existe
if(all(c("age","target") %in% names(df))) {
  age_target_stats <- df %>% filter(!is.na(age), !is.na(target)) %>% 
    group_by(target) %>% 
    summarise(n = n(), mean = mean(age), sd = sd(age), median = median(age), 
              q1 = quantile(age,0.25), q3 = quantile(age,0.75), .groups = "drop")
  age_target_stats %>% render_table(caption = "Edad por Target")
}
```

```{r mixed-plots-additional, fig.width=8, fig.height=4}
# Gráficos adicionales mixtos
if(all(c("age","target") %in% names(df))) {
  p_age_box <- ggplot(df, aes(x = target, y = age, fill = target)) + 
    geom_boxplot(alpha = 0.7) + theme_minimal() + theme(legend.position = "none")
  
  if("sleep_hours" %in% names(df)) {
    p_sleep_box <- ggplot(df, aes(x = target, y = sleep_hours, fill = target)) + 
      geom_boxplot(alpha = 0.7) + theme_minimal() + theme(legend.position = "none")
    p_age_box + p_sleep_box
  } else {
    p_age_box
  }
}
```

# 9. Pruebas de Hipótesis

## 9.1 Media de BMI vs 25

```{r test-mean-bmi}
alpha <- 0.05
if("bmi" %in% names(df)) {
  bmi_vec <- df %>% filter(!is.na(bmi)) %>% pull(bmi)
  set.seed(123)
  shapiro <- shapiro.test(sample(bmi_vec, min(5000, length(bmi_vec))))
  t_res <- t.test(bmi_vec, mu = 25)
  d_val <- effectsize::cohens_d(bmi_vec, mu = 25)
  decision <- if(t_res$p.value < alpha) "Se rechaza H0: evidencia de diferencia" else "No se rechaza H0: sin evidencia suficiente"
  render_table(
    tibble(
    Hipotesis_Nula = "mu = 25",
    Hipotesis_Alterna = "mu != 25",
    Media_Muestral = mean(bmi_vec),
    Estadistico_t = unname(t_res$statistic),
    gl = unname(t_res$parameter),
    p_valor = t_res$p.value,
    IC95_LI = t_res$conf.int[1],
    IC95_LS = t_res$conf.int[2],
    Cohens_d = d_val$Cohens_d,
    Decision = decision,
    Normalidad_Shapiro_p = shapiro$p.value
  ),
    caption = "Prueba t de una muestra para BMI",
    html_font_size = 9
  )
}
```

## 9.2 Proporción de "healthy" vs 0.5

```{r test-proportion}
if("target" %in% names(df)) {
  targ <- df %>% filter(!is.na(target))
  n_tot <- nrow(targ)
  n_healthy <- sum(targ$target == "healthy")
  p0 <- 0.5
  p_hat <- n_healthy/n_tot
  prop_res <- prop.test(n_healthy, n_tot, p = p0, correct = FALSE)
  cohens_h <- 2*asin(sqrt(p_hat)) - 2*asin(sqrt(p0))
  decision <- if(prop_res$p.value < 0.05) "Se rechaza H0" else "No se rechaza H0"
  render_table(
    tibble(
    Hipotesis_Nula = "p = 0.5",
    Hipotesis_Alterna = "p != 0.5",
    p_muestral = p_hat,
    Diferencia_abs = p_hat - p0,
    Estadistico_Chi2 = unname(prop_res$statistic),
    p_valor = prop_res$p.value,
    IC95_LI = prop_res$conf.int[1],
    IC95_LS = prop_res$conf.int[2],
    Cohens_h = cohens_h,
    Decision = decision
  ),
    caption="Prueba de proporción para categoría 'healthy'",
    html_font_size = 9
  )
}
```

# 10. Conclusiones

## Hallazgos Principales

**Variables Categóricas:**
- Distribución equilibrada en las principales variables demográficas
- Relaciones significativas entre variables categóricas (ej: género vs target)

**Variables Cuantitativas:**  
- Variables biométricas muestran distribuciones aproximadamente normales con algunos valores atípicos
- Correlaciones esperadas entre peso, altura y BMI
- Sugerencias distribucionales específicas por variable

**Análisis Mixto:**
- Diferencias en estadígrafos centrales y de dispersión por categorías
- Patrones visuales claros en boxplots segmentados

**Pruebas de Hipótesis:**
- Media de BMI vs 25: interpretar tabla (considerar magnitud de d y relevancia práctica, no solo p)
- Proporción "healthy" vs 0.5: interpretar diferencia absoluta y h (magnitud pequeña/mediana/grande)

# 11. Sesión

```{r session}
sessionInfo()
```
