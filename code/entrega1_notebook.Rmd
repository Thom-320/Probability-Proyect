---
title: "Entrega 1 - Notebook Reproducible"
author: "[Integrantes del Grupo]"
date: "`r format(Sys.Date(), '%d %b %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    df_print: paged
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 6,
  fig.height = 4,
  dpi = 150,
  fig.path = "../figs/entrega1/",
  dev = "png"
)
set.seed(123)

suppressPackageStartupMessages({
  library(tidyverse)
  library(janitor)
  library(psych)
  library(corrplot)
  library(rstatix)
  library(effectsize)
})

dir.create(file.path("..", "figs", "entrega1"), showWarnings = FALSE, recursive = TRUE)

render_table <- function(data, caption = NULL, html_font_size = 10, ...) {
  tab <- knitr::kable(data, caption = caption, ...)
  if (knitr::is_html_output() && requireNamespace("kableExtra", quietly = TRUE)) {
    tab <- kableExtra::kable_styling(tab, font_size = html_font_size)
  }
  tab
}
```

## 1. Carga y diagnóstico inicial

```{r load-data}
ruta_datos <- if (file.exists("data/health_lifestyle_classification.csv")) {
  "data/health_lifestyle_classification.csv"
} else {
  file.path("..", "data", "health_lifestyle_classification.csv")
}

datos <- readr::read_csv(ruta_datos, show_col_types = FALSE) |> 
  janitor::clean_names()

datos_resumen <- tibble(
  registros = nrow(datos),
  variables = ncol(datos),
  categ = sum(map_chr(datos, ~ class(.x)[1]) %in% c("character", "factor", "ordered")),
  cuant = sum(map_chr(datos, ~ class(.x)[1]) %in% c("numeric", "integer", "double"))
)

render_table(datos_resumen, caption = "Dimensión y tipología de la base")
```

```{r missing-values}
missing_tbl <- datos |> 
  summarise(across(everything(), ~ sum(is.na(.)))) |> 
  pivot_longer(everything(), names_to = "variable", values_to = "faltantes") |> 
  mutate(pct = round(faltantes / nrow(datos), 4)) |> 
  arrange(desc(faltantes))

render_table(head(missing_tbl, 15), caption = "Variables con mayor cantidad de NA")
```

> **Insight:** la mayoría de las variables no tiene valores faltantes; los mayores porcentajes se concentran en `insulin`, `daily_steps`, `exercise_type` y `alcohol_consumption`, por lo que cualquier modelado futuro debe considerar imputación o análisis segmentado.

## 2. Variables categóricas

```{r cat-vars}
cat_vars <- datos |> select(where(~ is.character(.x) || inherits(.x, "factor") || inherits(.x, "ordered"))) |> names()
cat_vars_principales <- intersect(c("gender", "target", "education_level", "diet_type"), cat_vars)
```

### 2.1 Tablas de frecuencia

```{r cat-tables}
frecuencias_cat <- datos |> 
  select(all_of(cat_vars_principales)) |> 
  pivot_longer(everything(), names_to = "variable", values_to = "categoria") |> 
  filter(!is.na(categoria)) |> 
  count(variable, categoria) |> 
  group_by(variable) |> 
  mutate(pct = round(n / sum(n), 3))

render_table(frecuencias_cat, caption = "Frecuencias y proporciones por categoría")
```

> **Insight:** `target` muestra distribución 70% healthy vs. 30% diseased; `gender` y `education_level` están relativamente balanceadas con ligera concentración en niveles altos de educación.

### 2.2 Gráficos univariados

```{r plot-gender}
plot_gender <- datos |> 
  filter(!is.na(gender)) |> 
  count(gender) |> 
  ggplot(aes(x = gender, y = n, fill = gender)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.2) +
  labs(title = "Distribución de género", x = NULL, y = "Frecuencia") +
  theme_minimal()
plot_gender
```

```{r plot-target}
plot_target <- datos |> 
  count(target) |> 
  ggplot(aes(x = target, y = n, fill = target)) +
  geom_col(show.legend = FALSE) +
  geom_text(aes(label = n), vjust = -0.2) +
  labs(title = "Distribución de target", x = NULL, y = "Frecuencia") +
  theme_minimal()
plot_target
```

```{r plot-education}
plot_education <- datos |> 
  filter(!is.na(education_level)) |> 
  count(education_level) |> 
  ggplot(aes(x = education_level, y = n)) +
  geom_col(fill = "#2A9D8F") +
  geom_text(aes(label = n), vjust = -0.2) +
  labs(title = "Niveles educativos declarados", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
plot_education
```

```{r plot-diet}
plot_diet <- datos |> 
  filter(!is.na(diet_type)) |> 
  count(diet_type) |> 
  ggplot(aes(x = diet_type, y = n)) +
  geom_col(fill = "#F4A261") +
  geom_text(aes(label = n), vjust = -0.2) +
  labs(title = "Tipo de dieta reportada", x = NULL, y = "Frecuencia") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1))
plot_diet
```

### 2.3 Cruces categóricos

```{r cross-gender-target}
ct_gender_target <- datos |> 
  filter(!is.na(gender), !is.na(target)) |> 
  count(gender, target) |> 
  group_by(gender) |> 
  mutate(prop = n / sum(n))

render_table(ct_gender_target, caption = "Tabla gender x target", html_font_size = 9)
```

```{r plot-gender-target}
plot_gender_target <- ct_gender_target |> 
  ggplot(aes(x = gender, y = prop, fill = target)) +
  geom_col(position = "fill") +
  scale_y_continuous(labels = scales::percent) +
  labs(title = "Proporciones de target por género", x = NULL, y = "Proporción") +
  theme_minimal()
plot_gender_target
```

```{r cross-education-target}
if ("education_level" %in% names(datos)) {
  ct_edu_target <- datos |> 
    filter(!is.na(education_level), !is.na(target)) |> 
    count(education_level, target) |> 
    group_by(education_level) |> 
    mutate(prop = n / sum(n))

  render_table(ct_edu_target, caption = "Tabla education_level x target", html_font_size = 9)
}
```

```{r plot-education-target}
if (exists("ct_edu_target")) {
  plot_edu_target <- ct_edu_target |> 
    ggplot(aes(x = education_level, y = prop, fill = target)) +
    geom_col() +
    scale_y_continuous(labels = scales::percent) +
    labs(title = "Proporciones de target por nivel educativo", x = "Nivel educativo", y = "Proporción") +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 30, hjust = 1))
  plot_edu_target
}
```

> **Insight:** las proporciones de `target` varían poco entre géneros, pero aumentan ligeramente las etiquetas `healthy` en niveles educativos superiores.

## 3. Variables cuantitativas

```{r num-vars}
num_vars <- datos |> select(where(is.numeric)) |> names()
num_clave <- intersect(c("age", "bmi", "sleep_hours", "daily_steps", "stress_level", "mental_health_score"), num_vars)
```

### 3.1 Estadísticos descriptivos

```{r num-summary}
resumen_cuant <- datos |> 
  select(all_of(num_clave)) |> 
  pivot_longer(everything(), names_to = "variable", values_to = "valor") |> 
  group_by(variable) |> 
  summarise(
    n = sum(!is.na(valor)),
    media = mean(valor, na.rm = TRUE),
    mediana = median(valor, na.rm = TRUE),
    sd = sd(valor, na.rm = TRUE),
    q1 = quantile(valor, 0.25, na.rm = TRUE),
    q3 = quantile(valor, 0.75, na.rm = TRUE),
    asimetria = psych::skew(valor, na.rm = TRUE),
    curtosis = psych::kurtosi(valor, na.rm = TRUE)
  )

render_table(resumen_cuant, caption = "Estadísticos clave por variable cuantitativa")
```

> **Insight:** `daily_steps` presenta mayor asimetría positiva; `bmi` se mantiene próximo a simetría con mediana ligeramente inferior a la media.

### 3.2 Histogramas y boxplots (uno por figura)

```{r hist-age}
 datos |> ggplot(aes(x = age)) +
  geom_histogram(bins = 30, fill = "#2A9D8F", color = "white") +
  labs(title = "Histograma edad", x = "Edad", y = "Frecuencia") +
  theme_minimal()
```

```{r box-age}
 datos |> ggplot(aes(y = age)) +
  geom_boxplot(fill = "#2A9D8F", alpha = 0.8) +
  labs(title = "Boxplot edad", y = "Edad") +
  theme_minimal()
```

```{r hist-bmi}
 datos |> ggplot(aes(x = bmi)) +
  geom_histogram(bins = 30, fill = "#E76F51", color = "white") +
  labs(title = "Histograma BMI", x = "BMI", y = "Frecuencia") +
  theme_minimal()
```

```{r box-bmi}
 datos |> ggplot(aes(y = bmi)) +
  geom_boxplot(fill = "#E76F51", alpha = 0.8) +
  labs(title = "Boxplot BMI", y = "BMI") +
  theme_minimal()
```

```{r hist-daily-steps}
 datos |> ggplot(aes(x = daily_steps)) +
  geom_histogram(bins = 30, fill = "#264653", color = "white") +
  labs(title = "Histograma daily_steps", x = "Pasos diarios", y = "Frecuencia") +
  theme_minimal()
```

```{r box-daily-steps}
 datos |> ggplot(aes(y = daily_steps)) +
  geom_boxplot(fill = "#264653", alpha = 0.8) +
  labs(title = "Boxplot daily_steps", y = "Pasos diarios") +
  theme_minimal()
```

### 3.3 Correlaciones y dispersión

```{r corr-matrix}
cor_vars <- intersect(c("age", "bmi", "height", "weight", "sleep_hours", "daily_steps"), num_vars)
cmat <- cor(datos[cor_vars], use = "pairwise.complete.obs")
corrplot::corrplot(cmat, method = "color", type = "upper", addCoef.col = "black", tl.col = "black")
```

```{r scatter-height-weight}
datos |> ggplot(aes(x = height, y = weight)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relación altura vs peso") +
  theme_minimal()
```

```{r scatter-weight-bmi}
datos |> ggplot(aes(x = weight, y = bmi)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relación peso vs BMI") +
  theme_minimal()
```

```{r scatter-age-bmi}
datos |> ggplot(aes(x = age, y = bmi)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relación edad vs BMI") +
  theme_minimal()
```

> **Insight:** peso y altura muestran correlación fuerte con BMI, mientras que edad aporta variación moderada.

### 3.4 Normalidad y sugerencia distribucional

```{r normality-tests}
normalidad <- map_df(c("age", "bmi", "sleep_hours", "daily_steps"), function(var) {
  if (!var %in% names(datos)) return(NULL)
  valores <- datos[[var]][!is.na(datos[[var]])]
  if (length(valores) > 5000) valores <- sample(valores, 5000)
  sw <- shapiro.test(valores)
  tibble(variable = var, shapiro_w = sw$statistic, shapiro_p = sw$p.value)
})

render_table(normalidad, caption = "Prueba de normalidad Shapiro-Wilk")
```

```{r distribution-suggestion}
dist_sugerida <- resumen_cuant |> 
  mutate(
    sugerencia = case_when(
      abs(asimetria) < 0.3 & abs(curtosis) < 1 ~ "Normal",
      asimetria > 0.8 ~ "Gamma / Log-normal",
      asimetria < -0.8 ~ "Distribución sesgada a la izquierda",
      TRUE ~ "Ver análisis gráfico"
    )
  ) |> select(variable, asimetria, curtosis, sugerencia)

render_table(dist_sugerida, caption = "Sugerencia distribucional por variable")
```

## 4. Análisis mixto (cuantitativa vs categórica)

```{r bmi-by-gender}
bmi_stats <- datos |> 
  filter(!is.na(bmi), !is.na(gender)) |> 
  group_by(gender) |> 
  summarise(
    n = n(),
    media = mean(bmi),
    sd = sd(bmi),
    mediana = median(bmi),
    q1 = quantile(bmi, 0.25),
    q3 = quantile(bmi, 0.75),
    .groups = "drop"
  )

render_table(bmi_stats, caption = "BMI por género")
```

```{r plot-bmi-gender}
datos |> 
  filter(!is.na(bmi), !is.na(gender)) |> 
  ggplot(aes(x = gender, y = bmi, fill = gender)) +
  geom_boxplot(alpha = 0.8, show.legend = FALSE) +
  labs(title = "Distribución de BMI por género", x = NULL, y = "BMI") +
  theme_minimal()
```

```{r age-target-stats}
age_target <- datos |> 
  filter(!is.na(age), !is.na(target)) |> 
  group_by(target) |> 
  summarise(
    n = n(),
    media = mean(age),
    sd = sd(age),
    mediana = median(age),
    q1 = quantile(age, 0.25),
    q3 = quantile(age, 0.75),
    .groups = "drop"
  )

render_table(age_target, caption = "Edad segmentada por target")
```

```{r plot-age-target}
datos |> 
  filter(!is.na(age), !is.na(target)) |> 
  ggplot(aes(x = target, y = age, fill = target)) +
  geom_boxplot(alpha = 0.8, show.legend = FALSE) +
  labs(title = "Edad por condición de salud", x = NULL, y = "Edad") +
  theme_minimal()
```

> **Insight:** las distribuciones de BMI y edad sugieren diferencias pequeñas entre grupos, aunque estadísticamente detectables dada la muestra grande.

## 5. Pruebas de hipótesis

```{r test-mean}
if ("bmi" %in% names(datos)) {
  bmi_vec <- datos$bmi[!is.na(datos$bmi)]
  prueba_media <- t.test(bmi_vec, mu = 25)
  tamaño_efecto <- effectsize::cohens_d(bmi_vec, mu = 25)
  resultado_media <- tibble(
    hipotesis_nula = "mu = 25",
    media_muestral = mean(bmi_vec),
    estadistico_t = prueba_media$statistic,
    gl = prueba_media$parameter,
    p_valor = prueba_media$p.value,
    ic95_li = prueba_media$conf.int[1],
    ic95_ls = prueba_media$conf.int[2],
    cohens_d = tamaño_efecto$Cohens_d
  )
  render_table(resultado_media, caption = "Prueba t una muestra para BMI", html_font_size = 9)
}
```

```{r test-proportion}
if ("target" %in% names(datos)) {
  exito <- sum(datos$target == "healthy", na.rm = TRUE)
  total <- sum(!is.na(datos$target))
  prueba_prop <- prop.test(exito, total, p = 0.5, correct = FALSE)
  cohens_h <- 2 * asin(sqrt(exito / total)) - 2 * asin(sqrt(0.5))
  resultado_prop <- tibble(
    hipotesis_nula = "p = 0.5",
    proporcion_muestral = exito / total,
    estadistico_chi2 = prueba_prop$statistic,
    p_valor = prueba_prop$p.value,
    ic95_li = prueba_prop$conf.int[1],
    ic95_ls = prueba_prop$conf.int[2],
    cohens_h = cohens_h
  )
  render_table(resultado_prop, caption = "Prueba de proporción para healthy", html_font_size = 9)
}
```

> **Insight:** la media de BMI supera ligeramente 25 con un tamaño de efecto pequeño; la proporción de individuos `healthy` es mayor que 0.5 con diferencia práctica moderada dado el tamaño muestral.

## 6. Diccionario de variables (resumen)

```{r diccionario}
if (file.exists("data/diccionario_variables.md")) {
  cat(readr::read_file("data/diccionario_variables.md"))
} else {
  message("Archivo de diccionario no encontrado.")
}
```

## 7. Información de sesión

```{r session-info}
sessionInfo()
```
